"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Edit=void 0;const i18n_1=require("@wordpress/i18n"),components_1=require("@wordpress/components"),data_1=require("@wordpress/data"),element_1=require("@wordpress/element"),icons_1=require("@wordpress/icons"),block_templates_1=require("@woocommerce/block-templates"),components_2=require("@woocommerce/components"),core_data_1=require("@wordpress/core-data"),upload_image_1=require("./upload-image"),downloads_menu_1=require("./downloads-menu"),manage_download_limits_modal_1=require("../../../components/manage-download-limits-modal"),edit_downloads_modal_1=require("./edit-downloads-modal");function getFileName(e){var o;const[t]=null!==(o=null==e?void 0:e.split("/").reverse())&&void 0!==o?o:[];return t}function stringifyId(e){return e?String(e):""}function stringifyEntityId(e){return{...e,id:stringifyId(e.id)}}function Edit({attributes:e,context:{postType:o}}){const t=(0,block_templates_1.useWooBlockProps)(e),[,n]=(0,core_data_1.useEntityProp)("postType",o,"downloadable"),[l,a]=(0,core_data_1.useEntityProp)("postType",o,"downloads"),[r,i]=(0,core_data_1.useEntityProp)("postType","product","download_limit"),[d,c]=(0,core_data_1.useEntityProp)("postType","product","download_expiry"),[m,s]=(0,element_1.useState)(),{allowedMimeTypes:_}=(0,data_1.useSelect)((e=>{const{getEditorSettings:o}=e("core/editor");return o()})),p=_?Object.values(_):[],{createErrorNotice:u}=(0,data_1.useDispatch)("core/notices"),[w,f]=(0,element_1.useState)(!1);function E(e){if(!Array.isArray(e))return;const o=e.filter((e=>!l.some((o=>o.file===e.url))));if(o.length!==e.length&&u(1===e.length?(0,i18n_1.__)("This file has already been added","woocommerce"):(0,i18n_1.__)("Some of these files have already been added","woocommerce")),o.length){l.length||n(!0);const e=o.map((e=>({id:stringifyId(e.id),file:e.url,name:e.title||e.alt||e.caption||getFileName(e.url)}))),t=l.map(stringifyEntityId);t.push(...e),a(t)}}function g(e){const o=l.reduce((function(o,t){return t.file===e.file?o:[...o,stringifyEntityId(t)]}),[]);o.length||n(!1),a(o)}function y(e){return function(){g(e)}}function b(e){return function(){s(e)}}function h(e){u("string"==typeof e?e:(0,i18n_1.__)("There was an error uploading files","woocommerce"))}return(0,element_1.createElement)("div",{...t},(0,element_1.createElement)("div",{className:"wp-block-woocommerce-product-downloads-field__header"},Boolean(l.length)&&(0,element_1.createElement)(components_1.Button,{variant:"tertiary",onClick:function(){f(!0)}},(0,i18n_1.__)("Manage limits","woocommerce")),(0,element_1.createElement)(downloads_menu_1.DownloadsMenu,{allowedTypes:p,onUploadSuccess:E,onUploadError:h})),(0,element_1.createElement)("div",{className:"wp-block-woocommerce-product-downloads-field__body"},(0,element_1.createElement)(components_2.MediaUploader,{label:Boolean(l.length)?"":(0,element_1.createElement)("div",{className:"wp-block-woocommerce-product-downloads-field__drop-zone-content"},(0,element_1.createElement)(upload_image_1.UploadImage,null),(0,element_1.createElement)("p",{className:"wp-block-woocommerce-product-downloads-field__drop-zone-label"},(0,element_1.createInterpolateElement)((0,i18n_1.__)("Supported file types: <Types /> and more. <link>View all</link>","woocommerce"),{Types:(0,element_1.createElement)(element_1.Fragment,null,"PNG, JPG, PDF, PPT, DOC, MP3, MP4"),link:(0,element_1.createElement)("a",{href:"https://codex.wordpress.org/Uploading_Files",target:"_blank",rel:"noreferrer",onClick:e=>e.stopPropagation()})}))),buttonText:"",allowedMediaTypes:p,multipleSelect:"add",onUpload:E,onFileUploadChange:E,onError:h}),Boolean(l.length)&&(0,element_1.createElement)(components_2.Sortable,{className:"wp-block-woocommerce-product-downloads-field__table"},l.map((e=>{const o=getFileName(e.file),t=e.file.startsWith("blob");return(0,element_1.createElement)(components_2.ListItem,{key:e.file},(0,element_1.createElement)("div",{className:"wp-block-woocommerce-product-downloads-field__table-filename"},(0,element_1.createElement)("span",null,e.name),e.name!==o&&(0,element_1.createElement)("span",{className:"wp-block-woocommerce-product-downloads-field__table-filename-description"},o)),(0,element_1.createElement)("div",{className:"wp-block-woocommerce-product-downloads-field__table-actions"},t&&(0,element_1.createElement)(components_1.Spinner,{"aria-label":(0,i18n_1.__)("Uploading file","woocommerce")}),!t&&(0,element_1.createElement)(components_1.Button,{onClick:b(e),variant:"tertiary"},(0,i18n_1.__)("Edit","woocommerce")),(0,element_1.createElement)(components_1.Button,{icon:icons_1.closeSmall,label:(0,i18n_1.__)("Remove file","woocommerce"),disabled:t,onClick:y(e)})))})))),w&&(0,element_1.createElement)(manage_download_limits_modal_1.ManageDownloadLimitsModal,{initialValue:{downloadLimit:r,downloadExpiry:d},onSubmit:function(e){i(e.downloadLimit),c(e.downloadExpiry),f(!1)},onClose:function(){f(!1)}}),m&&(0,element_1.createElement)(edit_downloads_modal_1.EditDownloadsModal,{downloableItem:{...m},onCancel:()=>s(null),onRemove:()=>{g(m),s(null)},onChange:e=>{s({...m,name:e})},onSave:()=>{const e=l.map((e=>e.id===m.id?m:e));a(e),s(null)}}))}exports.Edit=Edit;