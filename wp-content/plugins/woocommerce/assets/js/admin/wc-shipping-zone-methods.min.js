function isValidFormattedNumber(e,t){if("string"!=typeof e)return!1;if(""===e.trim())return!0;if(!t||"object"!=typeof t)return!1;var n=t.decimalSeparator||".",o=t.thousandSeparator||",",i=o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),s=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),d=new RegExp("([0-9,.' "+s+i+"]+)","g");const a=(e.match(d)||[]).map(e=>e.trim()).filter(e=>""!==e);if(0===a.length){return/^\[([a-zA-Z0-9_"'= ]+)\]/.test(e)}return a.every(e=>{if(!e||0===e.length||!e[0].match(/\d/))return!1;const t=e.match(/([^0-9])+/g);if(!t)return!0;const i=t.pop();if(t.length>0){if(new Set(t).size>1)return!1;if(t[0]!==o)return!1}if(i.trim()!==n.trim()){if(i.trim()!==o.trim())return!1;const t=e.split(i).pop();if(!t||3!==t.length||!/^\d{3}$/.test(t))return!1}return!0})}function maybeModifyDecimal(e,t){if(!e||"string"!=typeof e||!t||"object"!=typeof t||!t.decimalSeparator)return e;return!/[\[\]()\*\+\-\/\"'a-zA-Z]/.test(e)&&"."!==t.decimalSeparator&&e.includes(".")?e.replace(".",t.decimalSeparator):e}"undefined"!=typeof module&&module.exports?module.exports={isValidFormattedNumber:isValidFormattedNumber}:"function"==typeof define&&define.amd?define([],function(){return{isValidFormattedNumber:isValidFormattedNumber}}):window.WCNumberValidation={isValidFormattedNumber:isValidFormattedNumber},"undefined"!=typeof module&&module.exports?module.exports={maybeModifyDecimal:maybeModifyDecimal}:"function"==typeof define&&define.amd?define([],function(){return{maybeModifyDecimal:maybeModifyDecimal}}):window.WCMaybeModifyDecimal={maybeModifyDecimal:maybeModifyDecimal},function(e,t,n,o){e(function(){var i=e(".wc-shipping-zone-methods"),s=e(".wc-shipping-zone-method-rows"),d=e(".wc-shipping-zone-method-save"),a=n.template("wc-shipping-zone-method-row"),c=n.template("wc-shipping-zone-method-row-blank"),r=Backbone.Model.extend({changes:{},logChanges:function(e){var t=this.changes||{};_.each(e.methods,function(e,n){t.methods=t.methods||{methods:{}},t.methods[n]=_.extend(t.methods[n]||{instance_id:n},e)}),"undefined"!=typeof e.zone_name&&(t.zone_name=e.zone_name),"undefined"!=typeof e.zone_locations&&(t.zone_locations=e.zone_locations),"undefined"!=typeof e.zone_postcodes&&(t.zone_postcodes=e.zone_postcodes),this.changes=t,this.trigger("change:methods")},save:function(){var n=_.clone(this.changes);_.has(n,"zone_locations")&&_.isEmpty(n.zone_locations)&&(n.zone_locations=[""]),e.post(o+(o.indexOf("?")>0?"&":"?")+"action=woocommerce_shipping_zone_methods_save_changes",{wc_shipping_zones_nonce:t.wc_shipping_zones_nonce,changes:n,zone_id:t.zone_id},this.onSaveResponse,"json")},onSaveResponse:function(e,n){"success"===n&&(e.success?(e.data.zone_id!==t.zone_id&&(t.zone_id=e.data.zone_id,window.history.pushState&&window.history.pushState({},"","admin.php?page=wc-settings&tab=shipping&zone_id="+e.data.zone_id)),p.set("methods",e.data.methods),p.trigger("change:methods"),p.changes={},p.trigger("saved:methods"),window.onbeforeunload=null):window.alert(t.strings.save_failed))}}),l=Backbone.View.extend({rowTemplate:a,initialize:function(){this.listenTo(this.model,"change:methods",this.setUnloadConfirmation),this.listenTo(this.model,"saved:methods",this.clearUnloadConfirmation),this.listenTo(this.model,"saved:methods",this.render),this.listenTo(this.model,"rerender",this.render),s.on("change",{view:this},this.updateModelOnChange),s.on("sortupdate",{view:this},this.updateModelOnSort),e(window).on("beforeunload",{view:this},this.unloadConfirmation),d.on("click",{view:this},this.onSubmit),e(document.body).on("input change","#zone_name, #zone_locations, #zone_postcodes",{view:this},this.onUpdateZone),e(document.body).on("click",".wc-shipping-zone-method-settings",{view:this},this.onConfigureShippingMethod),e(document.body).on("click",".wc-shipping-zone-add-method",{view:this},this.onAddShippingMethod),e(document.body).on("wc_backbone_modal_response",this.onConfigureShippingMethodSubmitted),e(document.body).on("wc_region_picker_update",this.onUpdateZoneRegionPicker),e(document.body).on("wc_backbone_modal_next_response",this.onAddShippingMethodSubmitted),e(document.body).on("wc_backbone_modal_before_remove",this.onCloseConfigureShippingMethod),e(document.body).on("wc_backbone_modal_back_response",this.onConfigureShippingMethodBack),e(document.body).on("click",".wc-shipping-zone-postcodes-toggle",this.onTogglePostcodes),e(document.body).on("wc_backbone_modal_validation",{view:this},this.validateFormArguments),e(document.body).on("wc_backbone_modal_loaded",{view:this},this.onModalLoaded)},onUpdateZoneRegionPicker:function(e){var t=e.detail,n={};n.zone_locations=t,h.model.set("zone_locations",t),h.model.logChanges(n)},onUpdateZone:function(t){var n=t.data.view,o=n.model,i=e(this).val(),s=e(t.target).data("attribute"),d={};t.preventDefault(),d[s]=i,o.set(s,i),o.logChanges(d),n.render()},block:function(){e(this.el).block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},unblock:function(){e(this.el).unblock()},render:function(){var n=_.indexBy(this.model.get("methods"),"instance_id"),o=this.model.get("zone_name"),i=this;e(".wc-shipping-zone-name").text(o||t.strings.default_zone_name),this.$el.empty(),this.unblock(),_.size(n)?(n=_.sortBy(n,function(e){return parseInt(e.method_order,10)}),e.each(n,function(e,n){"yes"===n.enabled?n.enabled_icon='<span class="woocommerce-input-toggle woocommerce-input-toggle--enabled">'+t.strings.yes+"</span>":n.enabled_icon='<span class="woocommerce-input-toggle woocommerce-input-toggle--disabled">'+t.strings.no+"</span>",i.$el.append(i.rowTemplate(n));var o=i.$el.find('tr[data-id="'+n.instance_id+'"]');if(!n.has_settings){o.find(".wc-shipping-zone-method-title > a").replaceWith("<span>"+o.find(".wc-shipping-zone-method-title > a").text()+"</span>");var s=o.find(".wc-shipping-zone-method-delete");o.find(".wc-shipping-zone-method-title .row-actions").empty().html(s)}}),this.$el.find(".wc-shipping-zone-method-delete").on("click",{view:this},this.onDeleteRow),this.$el.find(".wc-shipping-zone-method-enabled a").on("click",{view:this},this.onToggleEnabled)):i.$el.append(c),this.initTooltips()},initTooltips:function(){e("#tiptip_holder").removeAttr("style"),e("#tiptip_arrow").removeAttr("style"),e(".tips").tipTip({attribute:"data-tip",fadeIn:50,fadeOut:50,delay:50})},onSubmit:function(e){d.addClass("is-busy"),e.data.view.block(),e.data.view.model.save(),e.preventDefault()},onDeleteRow:function(n){var i=n.data.view,s=i.model,d=_.indexBy(s.get("methods"),"instance_id"),a={},c=e(this).closest("tr").data("id");n.preventDefault(),window.confirm(t.strings.delete_shipping_method_confirmation)&&(h.block(),e.post({url:o+(o.indexOf("?")>0?"&":"?")+"action=woocommerce_shipping_zone_remove_method",data:{wc_shipping_zones_nonce:t.wc_shipping_zones_nonce,instance_id:c,zone_id:t.zone_id},success:function({data:e}){delete d[c],a.methods=a.methods||e.methods,s.set("methods",d),s.logChanges(a),i.clearUnloadConfirmation(),i.render(),h.unblock()},error:function(e,n,o){window.alert(t.strings.remove_method_failed),h.unblock()},dataType:"json"}))},onToggleEnabled:function(t){var n=t.data.view,o=e(t.target),i=n.model,s=_.indexBy(i.get("methods"),"instance_id"),d=o.closest("tr").data("id"),a="yes"===o.closest("tr").data("enabled")?"no":"yes",c={};t.preventDefault(),s[d].enabled=a,c.methods=c.methods||{methods:{}},c.methods[d]=_.extend(c.methods[d]||{},{enabled:a}),i.set("methods",s),i.logChanges(c),n.render()},setUnloadConfirmation:function(){this.needsUnloadConfirm=!0,d.prop("disabled",!1),d.removeClass("is-busy")},clearUnloadConfirmation:function(){this.needsUnloadConfirm=!1,d.attr("disabled","disabled")},unloadConfirmation:function(e){if(e.data.view.needsUnloadConfirm)return e.returnValue=t.strings.unload_confirmation_msg,window.event.returnValue=t.strings.unload_confirmation_msg,t.strings.unload_confirmation_msg},updateModelOnChange:function(t){var n=t.data.view.model,o=e(t.target),i=o.closest("tr").data("id"),s=o.data("attribute"),d=o.val(),a=_.indexBy(n.get("methods"),"instance_id"),c={};a[i][s]!==d&&(c.methods[i]={},c.methods[i][s]=d,a[i][s]=d),n.logChanges(c)},updateModelOnSort:function(e){var t=e.data.view.model,n=_.indexBy(t.get("methods"),"instance_id"),o={};_.each(n,function(e){var t=parseInt(e.method_order,10),s=parseInt(i.find('tr[data-id="'+e.instance_id+'"]').index()+1,10);t!==s&&(n[e.instance_id].method_order=s,o.methods=o.methods||{methods:{}},o.methods[e.instance_id]=_.extend(o.methods[e.instance_id]||{},{method_order:s}))}),_.size(o)&&t.logChanges(o)},onConfigureShippingMethod:function(t){var n=e(this).closest("tr").data("id"),o=t.data.view.model,i=_.indexBy(o.get("methods"),"instance_id")[n];if(!i.settings_html)return!0;t.preventDefault(),i.settings_html=h.reformatSettingsHTML(i.settings_html),e(this).WCBackboneModal({template:"wc-modal-shipping-method-settings",variable:{instance_id:n,method:i,status:"existing"},data:{instance_id:n,method:i,status:"existing"}}),h.highlightOnFocus(".wc-shipping-modal-price"),e(document.body).trigger("init_tooltips")},unformatShippingMethodNumericValues:function(e){if(!window.wc.wcSettings.CURRENCY)return e;const t=window.wc.wcSettings.CURRENCY,n=["woocommerce_free_shipping_min_amount","woocommerce_flat_rate_cost","woocommerce_flat_rate_no_class_cost"];return Object.keys(e).forEach(o=>{if(n.includes(o)||o.startsWith("woocommerce_flat_rate_class_cost_")){const n=e[o];try{const s=window.wc.currency.unformatLocalisedMonetaryValue(t,n);e[o]=s}catch(i){return}}}),e},onConfigureShippingMethodSubmitted:function(n,i,s){"wc-modal-shipping-method-settings"===i&&(h.block(),e.post(o+(o.indexOf("?")>0?"&":"?")+"action=woocommerce_shipping_zone_methods_save_settings",{wc_shipping_zones_nonce:t.wc_shipping_zones_nonce,instance_id:s.instance_id,data:h.unformatShippingMethodNumericValues(s)},function(n,o){"success"===o&&n.success?(e("table.wc-shipping-zone-methods").parent().find("#woocommerce_errors").remove(),n.data.errors.length>0&&h.showErrors(n.data.errors),_.size(h.model.changes)?h.model.save():h.model.onSaveResponse(n,o)):(window.alert(t.strings.save_failed),h.unblock())},"json"))},onConfigureShippingMethodBack:function(e,t){"wc-modal-shipping-method-settings"===t&&h.onAddShippingMethod(e)},showErrors:function(t){var n='<div id="woocommerce_errors" class="error notice is-dismissible">';e(t).each(function(e,t){n=n+"<p>"+t+"</p>"}),n+="</div>",e("table.wc-shipping-zone-methods").before(n)},highlightOnFocus:function(t){e(t).focus(function(){e(this).select()})},onAddShippingMethod:function(n){n.preventDefault(),e(this).WCBackboneModal({template:"wc-modal-add-shipping-method",variable:{zone_id:t.zone_id}}),e(".wc-shipping-zone-method-selector select").trigger("change"),e(".wc-shipping-zone-method-input input").change(function(){const t=e(".wc-shipping-zone-method-input input:checked").attr("id"),n=e(`#${t}-description`);e(".wc-shipping-zone-method-input-help-text").css("display","none"),n.css("display","block")})},reformatSettingsHTML:function(e){return[this.replaceHTMLTables,this.moveAdvancedCostsHelpTip,this.moveHTMLHelpTips,this.addCurrencySymbol].reduce((e,t)=>t(e),e)},moveAdvancedCostsHelpTip:function(t){const n=e(t),o=n.find("#wc-shipping-advanced-costs-help-text");o.addClass("wc-shipping-zone-method-fields-help-text");const i=n.find("#woocommerce_flat_rate_cost").closest("fieldset");return o.appendTo(i),n.prop("outerHTML")},addCurrencySymbol:function(t){if(!window.wc.wcSettings.CURRENCY||!window.wc.currency.localiseMonetaryValue)return t;const n=e(t),o=n.find(".wc-shipping-modal-price"),i=window.wc.wcSettings.CURRENCY,{symbol:s,symbolPosition:d}=i;return o.addClass(`wc-shipping-currency-size-${s.length}`),o.addClass(`wc-shipping-currency-position-${d}`),o.before(`<div class="wc-shipping-zone-method-currency wc-shipping-currency-position-${d}">${s}</div>`),o.each(t=>{const n=e(o[t]);let s=n.attr("value");try{s=WCMaybeModifyDecimal.maybeModifyDecimal(s,i)}catch(a){return}const d=window.wc.currency.localiseMonetaryValue(i,s);n.attr("value",d)}),n.prop("outerHTML")},moveHTMLHelpTips:function(t){const n=["woocommerce_flat_rate_cost","woocommerce_flat_rate_no_class_cost","woocommerce_flat_rate_class_cost_"],o=e(t),i=o.find("label");return i.each(t=>{const s=e(i[t]),d=s.find(".woocommerce-help-tip");if(0===d.length)return;const a=s.attr("for");if(n.some(e=>a.includes(e))){o.find(`label[for=${a}] span.woocommerce-help-tip`).addClass("wc-shipping-visible-help-text")}else{if("woocommerce_free_shipping_ignore_discounts"===a){o.find(`#${a}`).closest("fieldset").find("label").append(d)}else{const e=d.data("tip"),t=o.find(`#${a}`).closest("fieldset");t.length&&0===t.find(".wc-shipping-zone-method-fields-help-text").length&&t.append(`<div class="wc-shipping-zone-method-fields-help-text">${e}</div>`)}"Coupons discounts"===s.text().trim()&&s.text("")}}),o.prop("outerHTML")},replaceHTMLTables:function(t){const n=e("<div>"+t+"</div>"),o=n.find("table.form-table");return o.each(t=>{const n=e(o[t]),i=e('<div class="wc-shipping-zone-method-fields" />');i.html(n.html()),n.replaceWith(i)}),n.prop("outerHTML")},onAddShippingMethodSubmitted:function(n,i,s,d){"wc-modal-add-shipping-method"===i&&(h.block(),e("#btn-next").addClass("is-busy"),e.post(o+(o.indexOf("?")>0?"&":"?")+"action=woocommerce_shipping_zone_add_method",{wc_shipping_zones_nonce:t.wc_shipping_zones_nonce,method_id:s.add_method_id,zone_id:t.zone_id},function(n,o){"success"===o&&n.success&&(n.data.zone_id!==t.zone_id&&(t.zone_id=n.data.zone_id,window.history.pushState&&window.history.pushState({},"","admin.php?page=wc-settings&tab=shipping&zone_id="+n.data.zone_id)),h.model.set("methods",n.data.methods),d());var i=n.data.instance_id,s=n.data.methods[i];h.unblock(),s.settings_html?(s.settings_html=h.reformatSettingsHTML(s.settings_html),e(this).WCBackboneModal({template:"wc-modal-shipping-method-settings",variable:{instance_id:i,method:s,status:"new"},data:{instance_id:i,method:s,status:"new"}}),h.highlightOnFocus(".wc-shipping-modal-price")):(h.model.trigger("change:methods"),h.model.trigger("saved:methods")),e(document.body).trigger("init_tooltips")},"json"))},possiblyHideFreeShippingRequirements:function(t){if(Object.keys(t).includes("woocommerce_free_shipping_requires")){const n=null===t.woocommerce_free_shipping_requires||""===t.woocommerce_free_shipping_requires||"coupon"===t.woocommerce_free_shipping_requires,o=e("#woocommerce_free_shipping_requires").closest("fieldset"),i=o.nextAll("label"),s=o.nextAll("fieldset");i.each(t=>{e(i[t]).css("display",n?"none":"block")}),s.each(t=>{e(s[t]).css("display",n?"none":"block")})}},onModalLoaded:function(t,n){if("wc-modal-shipping-method-settings"===n){const n=e("#woocommerce_free_shipping_requires");if(n.length>0&&t.data.view.possiblyHideFreeShippingRequirements({woocommerce_free_shipping_requires:n.val()}),t.data.view.possiblyAddShippingClassLink(t),window.wc.wcSettings.CURRENCY&&window.wc.currency.localiseMonetaryValue){const t=window.wc.wcSettings.CURRENCY;e(".wc-shipping-modal-price").on("input",function(){const n=e(this).val();e(this).removeClass("wc-shipping-invalid-price"),e(this).siblings("span.wc-shipping-invalid-price-message").remove();const o=e(this).parents(".wc-backbone-modal-main");o.find("#btn-ok").removeAttr("disabled"),o.find(".wc-shipping-method-add-class-costs").show(),WCNumberValidation.isValidFormattedNumber(n,t)||(e(this).addClass("wc-shipping-invalid-price"),e('<span class="wc-shipping-zone-method-fields-help-text wc-shipping-invalid-price-message">'+shippingZoneMethodsLocalizeScript.strings.invalid_number_format+"</span>").insertAfter(this),o.find("#btn-ok").attr("disabled","disabled"),o.find(".wc-shipping-method-add-class-costs").hide())}),e(".wc-shipping-modal-price").on("blur",function(){const n=e(this).val(),o=window.wc.currency.localiseMonetaryValue(t,n);e(this).val(o)})}}},possiblyAddShippingClassLink:function(t){const n=e("article.wc-modal-shipping-method-settings"),o=n.data("shipping-classes-count"),i=(n.data("status"),n.data("id")),s=t.data.view.model;if("flat_rate"===_.indexBy(s.get("methods"),"instance_id")[i].id&&0===o){n.find(".wc-shipping-method-add-class-costs").css("display","block")}},validateFormArguments:function(e,t,n){if("wc-modal-add-shipping-method"===t){if(n.add_method_id){const e=document.getElementById("btn-next");e.disabled=!1,e.classList.remove("disabled")}}else"wc-modal-shipping-method-settings"===t&&e.data.view.possiblyHideFreeShippingRequirements(n)},onCloseConfigureShippingMethod:function(n,i,s,d){if("wc-modal-shipping-method-settings"===i){var a=e("#btn-ok").data();if(!d&&a&&"new"===a.status){h.block();var c=h,r=c.model,l=_.indexBy(r.get("methods"),"instance_id"),p={},m=s.instance_id;e.post({url:o+(o.indexOf("?")>0?"&":"?")+"action=woocommerce_shipping_zone_remove_method",data:{wc_shipping_zones_nonce:t.wc_shipping_zones_nonce,instance_id:m,zone_id:t.zone_id},success:function({data:e}){delete l[m],p.methods=p.methods||e.methods,r.set("methods",l),r.logChanges(p),c.clearUnloadConfirmation(),c.render(),h.unblock()},error:function(e,n,o){window.alert(t.strings.remove_method_failed),h.unblock()},dataType:"json"})}}},onTogglePostcodes:function(t){t.preventDefault();var n=e(this).closest("tr");n.find(".wc-shipping-zone-postcodes").show(),n.find(".wc-shipping-zone-postcodes-toggle").hide()}}),p=new r({methods:t.methods,zone_name:t.zone_name}),h=new l({model:p,el:s});h.render(),s.sortable({items:"tr",cursor:"move",axis:"y",handle:"td.wc-shipping-zone-method-sort",scrollSensitivity:40})})}(jQuery,shippingZoneMethodsLocalizeScript,wp,ajaxurl);